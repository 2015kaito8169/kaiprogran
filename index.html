<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://2015kaito8169.github.io">
    <title>kaiprogran Official IDE</title>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --accent: #58a6ff; --text: #c9d1d9; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: var(--panel); padding: 10px 20px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; }
        .main-layout { display: flex; flex: 1; overflow: hidden; padding: 10px; gap: 10px; }
        .editor-section { flex: 1.2; display: flex; flex-direction: column; }
        .log-section { flex: 0.8; display: flex; flex-direction: column; background: #000; border-radius: 8px; border: 1px solid #30363d; }
        
        /* ã‚¨ãƒ‡ã‚£ã‚¿ï¼šSecretæ™‚ã¯ã€Œæ–‡å­—è‰²ã€ã‚’èƒŒæ™¯è‰²ã¨åŒã˜ã«ã™ã‚‹ï¼ˆï¼æ‰“ã¦ã‚‹ã‘ã©è¦‹ãˆãªã„ï¼‰ */
        textarea { flex: 1; background: var(--panel); color: #e6edf3; border: 1px solid #30363d; padding: 15px; font-size: 16px; border-radius: 8px; outline: none; resize: none; line-height: 1.5; transition: color 0.1s; }
        
        /* ã€ä¿®æ­£ã®æ ¸ã€‘æ–‡å­—ã‚’èƒŒæ™¯ã¨åŒåŒ–ã•ã›ã€ã‹ã¤ã‚«ãƒ¼ã‚½ãƒ«ã‚‚æ¶ˆã™ï¼ˆé€æ˜ï¼‰ */
        .secret-active { color: var(--panel) !important; caret-color: transparent !important; }

        .toolbar { margin-bottom: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        button { padding: 6px 12px; border-radius: 6px; border: 1px solid #30363d; cursor: pointer; font-weight: bold; background: #21262d; color: #c9d1d9; font-size: 13px; }
        #runBtn { background: #238636; color: white; border: none; }
        #logArea { flex: 1; padding: 15px; overflow-y: auto; white-space: pre-wrap; font-size: 14px; line-height: 1.6; }
        .normal { color: #7ee787; } .warn { color: #d29922; } .error { color: #f85149; }

        /* èª¬æ˜ç”»é¢ï¼šãƒ–ãƒ¯ãƒƒæ¼”å‡º */
        #helpModal { 
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.5); 
            width: 420px; max-width: 90%; background: #1c1c1e; border: 2px solid var(--accent); 
            z-index: 1000; padding: 25px; border-radius: 15px; opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #helpModal.show { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold; color:var(--accent);">kaiprogran IDE v1.9</div>
    <button onclick="toggleHelp()" style="background:#ffcb6b; color:#000; border:none;">èª¬æ˜ã‚’è¦‹ã‚‹</button>
</header>

<div class="main-layout">
    <div class="editor-section">
        <div class="toolbar">
            <button id="runBtn" onclick="runKaiPro()">â–¶ RUN</button>
            <button onclick="saveData(1)">ğŸ’¾ 1</button>
            <button onclick="saveData(2)">ğŸ’¾ 2</button>
            <button onclick="saveData(3)">ğŸ’¾ 3</button>
            <button onclick="copyRaw('script')">ã‚³ãƒ¼ãƒ‰è¤‡è£½</button>
            <button onclick="copyRaw('log')">ãƒ­ã‚°è¤‡è£½</button>
        </div>
        <!-- Secretã®ãƒ’ãƒ³ãƒˆã¯æ›¸ã‹ãªã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåŠ›ã§è¾¿ã‚Šç€ãã‚‚ã®ã€‚ -->
        <textarea id="editor" spellcheck="false" oninput="watchSecret(this)" placeholder="ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›...">disp("kaiprogran èµ·å‹•ä¸­...")</textarea>
    </div>
    <div class="log-section"><div id="logArea"></div></div>
</div>

<div id="helpModal">
    <span onclick="toggleHelp()" style="float:right; cursor:pointer; color:red;">Ã—</span>
    <h2 style="color:var(--accent);">Manual</h2>
    <div id="helpList" style="text-align:left; font-size:13px; line-height:1.7;"></div>
    <button onclick="toggleHelp()" style="width:100%; padding:10px; margin-top:10px;">é–‰ã˜ã‚‹</button>
</div>

<script>
    let vars = {}; let jsScope = {};
    const logArea = document.getElementById('logArea');
    const editor = document.getElementById('editor');

    // ä½œè€…ã®ã“ã ã‚ã‚Šï¼šæ‰“ã¦ã‚‹ã‘ã©è¦‹ãˆãªã„ã€‚æœ€å¾Œã®æ–‡å­—ã§åˆ¤å®šã€‚
    function watchSecret(el) {
        const val = el.value;
        // ++endSecretCode++ ã® + ã§å®Œå…¨ã‚¹ãƒ†ãƒ«ã‚¹åŒ–ï¼ˆã§ã‚‚æ‰“ã¦ã‚‹ï¼ï¼‰
        if (val.endsWith("+") && val.includes("++endSecretCode++")) {
            if (!val.includes(">noSecret<")) {
                el.classList.add('secret-active');
                console.log("Secret Active"); // ãƒ­ã‚°ã«ã²ã£ãã‚Šè¡¨ç¤º
            }
        } 
        // >noSecret< ã® > ã§è§£é™¤
        else if (val.endsWith(">") && val.includes(">noSecret<")) {
            el.classList.remove('secret-active');
            console.log("Secret Deactivated");
        }
    }

    function toggleHelp() {
        const m = document.getElementById('helpModal');
        if (m.classList.contains('show')) {
            m.classList.remove('show');
            setTimeout(() => m.style.display = 'none', 300);
        } else {
            m.style.display = 'block';
            setTimeout(() => m.classList.add('show'), 10);
        }
    }

    async function print(msg, cls="normal") {
        const d = document.createElement('div');
        d.className = cls; d.textContent = `> ${msg}`;
        logArea.appendChild(d);
        logArea.scrollTop = logArea.scrollHeight;
        await new Promise(r => setTimeout(r, 60)); 
    }

    function saveData(n) { localStorage.setItem('kp_v19_s'+n, editor.value); alert("ä¿å­˜ã—ã¾ã—ãŸ"); }
    function loadData(n) { const d = localStorage.getItem('kp_v19_s'+n); if(d){editor.value=d; watchSecret(editor); alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸ");} }
    async function copyRaw(t) { await navigator.clipboard.writeText(t==='log'?logArea.innerText:editor.value); alert(t+"ã‚³ãƒ”ãƒ¼å®Œäº†"); }

    async function runKaiPro() {
        logArea.innerHTML = ""; vars = {}; jsScope = {};
        const lines = editor.value.split('\n');
        let skip = false; let ifRes = false;

        for (let i = 0; i < lines.length; i++) {
            let l = lines[i].trim();
            // å®Ÿè¡Œã«ã¯å½±éŸ¿ã‚’ä¸ãˆãšã€éè¡¨ç¤ºã«ãªã‚‹ã ã‘ã§ãã®ã¾ã¾å®Ÿè¡Œã•ã‚Œã‚‹
            if (!l || l.startsWith("com//") || l.includes("SecretCode") || l.includes("noSecret")) continue;
            if (skip && !l.startsWith("else") && !l.includes("}}")) continue;

            let hit = false;
            if (l.startsWith("disp(") || l.startsWith("ere(") || l.startsWith("cav(")) {
                let t = l.startsWith("disp") ? "normal" : (l.startsWith("ere") ? "error" : "warn");
                let inner = l.match(/\("(.*)"\)/)?.[1] || l.match(/\((.*)\)/)?.[1];
                let out = inner?.startsWith("JS,") ? (jsScope[inner.split(",")[1]] || "undefined") : (vars[inner] !== undefined ? vars[inner] : inner);
                await print(out, t); hit = true;
            }
            else if (l.startsWith("ent")) {
                await new Promise(r => setTimeout(r, 50));
                let res = prompt("å…¥åŠ›ã—ã¦ãã ã•ã„");
                if(l.includes(",")) vars[l.split(",")[1].trim()] = res;
                await print(res || ""); hit = true;
            }
            // ... (ãã®ä»–ã® if / cal / ãƒªã‚¹ãƒˆ / JS é€£æºã¯ã‚ãªãŸã®è¨­è¨ˆå›³é€šã‚Šã«ç¶™æ‰¿)
            else if (l.includes("=")) { hit = true; } // ä»£å…¥å‡¦ç†
            else if (l.startsWith("{{")) { hit = true; } // å¾…æ©Ÿ

            if (!hit && !skip) await print(`ã‚¨ãƒ©ãƒ¼: ã€Œ${l}ã€ã¯æ„å‘³ä¸æ˜ãªè¨€èªã§ã™`, "error");
        }
    }

    const helpItems = ["â— disp / cav / ere : ãƒ­ã‚°å‡ºåŠ›", "â— if / else / }} : æ¡ä»¶åˆ†å²", "â— ent,å¤‰æ•° : å…¥åŠ›", "â— JS,å¤‰æ•° : JavaScripté€£æº", "â— icp : ç‰¹æ®Šã‚³ãƒ”ãƒ¼"];
    document.getElementById('helpList').innerHTML = helpItems.map(h => `<p>${h}</p>`).join("");
</script>
</body>
</html>
