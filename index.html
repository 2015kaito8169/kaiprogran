<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://2015kaito8169.github.io">
    <title>kaiprogran Official IDE</title>
    <style>
        :root { --bg: #0d1117; --panel: #161b22; --accent: #58a6ff; --text: #c9d1d9; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { background: var(--panel); padding: 10px 20px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; }
        .main-layout { display: flex; flex: 1; overflow: hidden; padding: 10px; gap: 10px; }
        .editor-section { flex: 1.2; display: flex; flex-direction: column; }
        .log-section { flex: 0.8; display: flex; flex-direction: column; background: #000; border-radius: 8px; border: 1px solid #30363d; }
        textarea { flex: 1; background: var(--panel); color: #e6edf3; border: 1px solid #30363d; padding: 15px; font-size: 16px; border-radius: 8px; outline: none; resize: none; }
        .toolbar { margin-bottom: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        button { padding: 6px 12px; border-radius: 6px; border: 1px solid #30363d; cursor: pointer; font-weight: bold; background: #21262d; color: #c9d1d9; font-size: 13px; }
        #runBtn { background: #238636; color: white; border: none; }
        #logArea { flex: 1; padding: 15px; overflow-y: auto; white-space: pre-wrap; font-size: 14px; line-height: 1.5; }
        .normal { color: #7ee787; } .warn { color: #d29922; } .error { color: #f85149; }

        /* èª¬æ˜ç”»é¢ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ã®ä¿®æ­£ */
        #helpModal { 
            display: none; /* æœ€åˆã¯éš ã™ */
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            width: 400px; max-width: 90%; /* ãƒ‡ã‚«ã™ãé˜²æ­¢ */
            max-height: 80vh; 
            background: #1c1c1e; border: 2px solid var(--accent); 
            z-index: 9999; padding: 20px; border-radius: 12px; 
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            overflow-y: auto;
        }
        .close-x { position: absolute; top: 10px; right: 15px; cursor: pointer; color: #ff453a; font-size: 20px; font-weight: bold; }
        .more-btn { background: var(--accent); color: #000; padding: 10px; border-radius: 6px; display: block; width: 100%; text-align: center; text-decoration: none; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold; color:var(--accent);">kaiprogran IDE v1.5</div>
    <button onclick="toggleHelp()" style="background:#ffcb6b; color:#000; border:none;">èª¬æ˜ã‚’è¦‹ã‚‹</button>
</header>

<div class="main-layout">
    <div class="editor-section">
        <div class="toolbar">
            <button id="runBtn" onclick="runKaiPro()">â–¶ RUN</button>
            <button onclick="saveData(1)">ğŸ’¾ 1</button><button onclick="saveData(2)">ğŸ’¾ 2</button><button onclick="saveData(3)">ğŸ’¾ 3</button>
            <button onclick="loadData(1)">ğŸ“‚ 1</button><button onclick="loadData(2)">ğŸ“‚ 2</button><button onclick="loadData(3)">ğŸ“‚ 3</button>
            <button onclick="copyRaw('script')">ã‚³ãƒ¼ãƒ‰è¤‡è£½</button>
            <button onclick="copyRaw('log')">ãƒ­ã‚°è¤‡è£½</button>
        </div>
        <textarea id="editor" spellcheck="false">disp("kaiprogran ã¸ã‚ˆã†ã“ã")</textarea>
    </div>
    <div class="log-section"><div id="logArea"></div></div>
</div>

<!-- èª¬æ˜ç”»é¢ -->
<div id="helpModal">
    <span class="close-x" onclick="toggleHelp()">Ã—</span>
    <h2 style="color:var(--accent); margin-top:0;">kaiprogran èª¬æ˜</h2>
    <div style="text-align:left; font-size:13px; line-height:1.6;">
        <p>â— <b>disp("å†…å®¹")</b> : ãƒ­ã‚°å‡ºåŠ›</p>
        <p>â— <b>if (A = B) / else / }}</b> : æ¡ä»¶åˆ†å²</p>
        <p>â— <b>icp("...")</b> : ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½</p>
        <p>â— <b>keypush"A" { å‘½ä»¤ }</b> : ã‚­ãƒ¼å…¥åŠ›</p>
    </div>
    <a href="https://2015kaito8169.github.io" target="_blank" class="more-btn">ã‚‚ã£ã¨è©³ã—ã (å…¬å¼ã‚µã‚¤ãƒˆ)</a>
    <button onclick="toggleHelp()" style="margin-top:10px; width:100%; background:#444; color:#fff;">é–‰ã˜ã‚‹</button>
</div>

<script>
    let vars = {}; let lists = {}; let jsScope = {};
    const logArea = document.getElementById('logArea');
    const editor = document.getElementById('editor');

    // èª¬æ˜ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function toggleHelp() { 
        const m = document.getElementById('helpModal'); 
        m.style.display = (m.style.display === 'block') ? 'none' : 'block'; 
    }

    function print(msg, cls="normal") {
        const d = document.createElement('div'); d.className = cls; d.textContent = `> ${msg}`;
        logArea.appendChild(d); logArea.scrollTop = logArea.scrollHeight;
    }

    function saveData(n) { localStorage.setItem('kp_s'+n, editor.value); alert(`ä¿å­˜${n}å®Œäº†`); }
    function loadData(n) { const d = localStorage.getItem('kp_s'+n); if(d){editor.value=d; alert(`èª­è¾¼${n}å®Œäº†`);}else{alert("ç©ºã§ã™");} }
    async function copyRaw(t) { await navigator.clipboard.writeText(t==='log'?logArea.innerText:editor.value); alert(t+"ã‚³ãƒ”ãƒ¼å®Œäº†"); }

    async function runKaiPro() {
        logArea.innerHTML = ""; vars = {}; lists = {}; jsScope = {};
        const lines = editor.value.split('\n');
        let skip = false; let ifRes = false;

        for (let i = 0; i < lines.length; i++) {
            let l = lines[i].trim();
            if (!l || l.startsWith("com//")) continue;
            if (skip && !l.startsWith("else") && !l.includes("}}")) continue;

            let hit = false;
            if (l.startsWith("disp(") || l.startsWith("ere(") || l.startsWith("cav(")) {
                let t = l.startsWith("disp") ? "normal" : (l.startsWith("ere") ? "error" : "warn");
                let c = l.match(/\((.*)\)/);
                if(c){
                    let inner = c[1].replace(/"/g,"");
                    let out = inner.startsWith("JS,") ? (jsScope[inner.split(",")[1]] || "undefined") : (vars[inner] !== undefined ? vars[inner] : inner);
                    print(out, t); hit = true;
                }
            }
            else if (l.startsWith("if")) {
                let m = l.match(/\((.*)\)/);
                if(m){
                    let cond = m[1].split("=");
                    let L = vars[cond[0].trim()] || cond[0].trim().replace(/"/g,"");
                    let R = vars[cond[1].trim()] || cond[1].trim().replace(/"/g,"");
                    if(L == R){ skip = false; ifRes = true; } else { skip = true; ifRes = false; }
                }
                hit = true;
            }
            else if (l.startsWith("else")) { skip = ifRes; hit = true; }
            else if (l.includes("}}")) { skip = false; hit = true; }
            else if (l.startsWith("keypush")) {
                let kMatch = l.match(/"([^"]+)"/);
                if(kMatch){
                    let key = kMatch[1].toUpperCase();
                    let actionMatch = l.match(/\{(.*)\}/);
                    print(`${key}ã‚­ãƒ¼å¾…æ©Ÿä¸­...`, "warn");
                    window.addEventListener('keydown', (e) => {
                        if (e.key.toUpperCase() === key) {
                            if(actionMatch) { 
                                let action = actionMatch[1].trim();
                                if(action.startsWith("disp(")) print(action.match(/\("(.*)"\)/)[1]);
                            } else { print(`${key}å…¥åŠ›æˆåŠŸï¼`, "normal"); }
                        }
                    }, { once: true });
                }
                hit = true;
            }
            else if (l.startsWith("icp(")) {
                let inner = l.match(/\((.*)\)/)[1];
                let txt = (inner === '"""log"""') ? logArea.innerText : (inner === '"""script"""' ? editor.value : inner.replace(/"/g,""));
                navigator.clipboard.writeText(txt); hit = true;
            }
            else if (l.includes("=")) {
                let p = l.split("="); let n = p[0].trim(); let v = p[1].trim();
                if (v.startsWith("cal(")) {
                    let exp = v.match(/\((.*)\)/)[1].replace(/JS,([a-z0-9]+)/gi, (m,v)=>jsScope[v]||0).replace(/([ã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾ a-z0-9]+)/gi, m => vars[m] !== undefined ? vars[m] : m).replace(/"/g,"");
                    try { vars[n] = eval(exp); } catch(e) { print("è¨ˆç®—ä¸å¯", "error"); }
                } else { vars[n] = v.replace(/"/g, ""); }
                hit = true;
            }
            else if (l.startsWith("{{") || l.startsWith("ent")) {
                if(l.startsWith("{{")){ let s = l.match(/\d+/); await new Promise(r => setTimeout(r, parseInt(s[0]) * 1000)); }
                if(l.startsWith("ent")){ let r = prompt("å…¥åŠ›"); let vName = l.split(",")[1]; if(vName) vars[vName.trim()]=r; print(r); }
                hit = true;
            }
            if (!hit && !skip) print(`ã‚¨ãƒ©ãƒ¼: ã€Œ${l}ã€ã¯æ„å‘³ä¸æ˜ãªè¨€èªã§ã™`, "error");
        }
    }
</script>
</body>
</html>
