<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
        <link rel="icon" type="image/png" href="/kaides/favicon.png">
　　　　<title>kaiprogran</title>
    <style>
        body { font-family: 'Consolas', monospace; background: #0f111a; color: #fff; margin: 20px; }
        .container { max-width: 1000px; margin: auto; }
        h1 { color: #82aaff; border-bottom: 2px solid #82aaff; margin-bottom: 10px; }
        textarea { width: 100%; height: 350px; background: #1a1c25; color: #a6accd; border: 1px solid #3b3f51; padding: 15px; font-size: 16px; border-radius: 8px; box-sizing: border-box; outline: none; }
        .controls { margin: 15px 0; display: flex; gap: 8px; flex-wrap: wrap; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        #runBtn { background: #c3e88d; color: #000; }
        .btn-slot { background: #444; color: #fff; }
        .btn-blue { background: #82aaff; color: #000; }
        .btn-purple { background: #c792ea; color: #000; }
        #log { background: #000; padding: 15px; height: 200px; overflow-y: auto; border: 1px solid #3b3f51; border-radius: 8px; margin-bottom: 10px; white-space: pre-wrap; line-height: 1.4; }
        .log-normal { color: #80cbc4; }
        .log-warn { color: #ffcb6b; }
        .log-error { color: #f07178; }
        /* モーダル */
        #helpModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 85%; background: #222; border: 2px solid #82aaff; z-index: 100; padding: 20px; border-radius: 10px; overflow-y: auto; text-align: center; }
        .help-content { text-align: left; margin-bottom: 20px; line-height: 1.6; }
        .more-btn { background: #82aaff; color: #000; padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>kaiprogran IDE</h1>
    <textarea id="editor" spellcheck="false">com// 初心者用テンプレート
var = 1
var2 = 0
if (var = var2)
  disp("ここには来ないはず")
}}
else
  disp("計算成功！違う値です")
}}

icp("公式テンプレート実行完了")
</textarea>

    <div class="controls">
        <button id="runBtn" onclick="runKaiPro()">▶ 実行 (RUN)</button>
        <button class="btn-slot" onclick="saveData(1)">保存1</button>
        <button class="btn-slot" onclick="saveData(2)">保存2</button>
        <button class="btn-slot" onclick="saveData(3)">保存3</button>
        <button class="btn-slot" onclick="loadData(1)">読込1</button>
        <button class="btn-slot" onclick="loadData(2)">読込2</button>
        <button class="btn-slot" onclick="loadData(3)">読込3</button>
        <button class="btn-blue" onclick="copyRaw('script')">コードコピー</button>
        <button class="btn-purple" onclick="copyRaw('log')">ログコピー</button>
        <button style="background:#ffcb6b; color:#000;" onclick="toggleHelp()">説明を見る</button>
    </div>

    <div id="log"></div>
</div>

<div id="helpModal">
    <button onclick="toggleHelp()" style="float:right; background:red; color:white; padding:5px 10px;">閉じる</button>
    <h2>kaiprogran 説明書</h2>
    <div class="help-content">
        <p>● <b>icp:</b> コピー機能。 icp("""log""") で全ログ、 icp("""script""") で全コード、 icp("1""log""") でログの指定行をコピー。</p>
        <p>● <b>if / else / }}:</b> 比較は = 。条件が合わない時は else へ。最後は }} で終了。</p>
        <p>● <b>JSお取り寄せ:</b> ++StartScript++ 内で this.a = 1 とし、外で JS,a で呼び出す。</p>
        <p>● <b>リスト:</b> {R}["a","b"] で作成。 {R,push="c"} で追加。 (R="0") で取り出し。</p>
    </div>
    <hr>
    <p>もっと詳しい使い方は公式解説ページへ！</p>
<button class="more-btn" onclick="window.open('https://2015kaito8169.github.io/kaides/', '_blank')">もっと詳しく</button>

</div>

<script>
    let variables = {};
    let lists = {};
    let jsScope = {};

    function printLog(msg, type = "normal") {
        const div = document.createElement('div');
        div.className = `log-${type}`;
        div.textContent = `> ${msg}`;
        document.getElementById('log').appendChild(div);
        document.getElementById('log').scrollTop = 9999;
    }

    function toggleHelp() {
        const m = document.getElementById('helpModal');
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    function saveData(slot) {
        localStorage.setItem('kai_slot_' + slot, document.getElementById('editor').value);
        alert("スロット" + slot + "に保存しました");
    }

    function loadData(slot) {
        const data = localStorage.getItem('kai_slot_' + slot);
        if(data) {
            document.getElementById('editor').value = data;
            alert("スロット" + slot + "から読み込みました");
        } else {
            alert("スロット" + slot + "は空です");
        }
    }

    async function copyRaw(type) {
        let text = (type === 'log') ? document.getElementById('log').innerText : document.getElementById('editor').value;
        await navigator.clipboard.writeText(text);
        alert(type + " をコピーしました");
    }

    async function runKaiPro() {
        const logArea = document.getElementById('log');
        logArea.innerHTML = "";
        variables = {}; lists = {}; jsScope = {};
        const lines = document.getElementById('editor').value.split('\n');
        let skipMode = false;
        let ifRes = false;

        for (let i = 0; i < lines.length; i++) {
            let l = lines[i].trim();
            if (!l || l.startsWith("com//")) continue;

            if (skipMode && !l.startsWith("else") && !l.includes("}}")) continue;

            let matched = false;

            if (l.startsWith("icp(")) {
                let inner = l.match(/\((.*)\)/)[1];
                let txt = "";
                if (inner === '"""log"""') txt = logArea.innerText;
                else if (inner === '"""script"""') txt = document.getElementById('editor').value;
                else if (inner.includes('""log"""')) {
                    let idx = inner.match(/\d+/)[0];
                    txt = logArea.innerText.split('\n')[idx] || "";
                } else {
                    let key = inner.replace(/"/g, "");
                    txt = variables[key] !== undefined ? variables[key] : key;
                }
                navigator.clipboard.writeText(txt);
                matched = true;
            }
            else if (l.startsWith("disp(") || l.startsWith("ere(") || l.startsWith("cav(")) {
                let type = l.startsWith("disp") ? "normal" : (l.startsWith("ere") ? "error" : "warn");
                let content = l.match(/\((.*)\)/)[1].replace(/"/g, "");
                let out = content.startsWith("JS,") ? (jsScope[content.split(",")[1]] || "undefined") : (variables[content] !== undefined ? variables[content] : content);
                printLog(out, type); matched = true;
            }
            else if (l.startsWith("if")) {
                let cond = l.match(/\((.*)\)/)[1].split("=");
                let left = variables[cond[0].trim()] || cond[0].trim().replace(/"/g,"");
                let right = variables[cond[1].trim()] || cond[1].trim().replace(/"/g,"");
                if (left == right) { skipMode = false; ifRes = true; } else { skipMode = true; ifRes = false; }
                matched = true;
            }
            else if (l.startsWith("else")) { skipMode = ifRes; matched = true; }
            else if (l.includes("}}")) { skipMode = false; matched = true; }
            else if (l.startsWith("++StartScript++")) {
                let js = ""; i++;
                while(i < lines.length && !lines[i].includes("++endscript++")) { js += lines[i] + "\n"; i++; }
                try {
                    let func = new Function('scope', js + "\nreturn this;");
                    Object.assign(jsScope, func.call(window, jsScope));
                } catch(e) { printLog(e.message, "error"); }
                matched = true;
            }
            else if (l.includes("=")) {
                let p = l.split("=");
                let name = p[0].trim();
                let val = p[1].trim();
                if (val.startsWith("cal(")) {
                    let exp = val.match(/\((.*)\)/)[1].replace(/JS,([a-z0-9]+)/gi, (m,v)=>jsScope[v]||0)
                                 .replace(/([ぁ-んァ-ヶー一-龠a-z0-9]+)/gi, m => variables[m] !== undefined ? variables[m] : m).replace(/"/g,"");
                    try { variables[name] = eval(exp); } catch(e) { printLog("計算不可", "error"); }
                } else { variables[name] = val.replace(/"/g, ""); }
                matched = true;
            }
            else if (l.startsWith("ent")) {
                let res = prompt("入力してください");
                if (l.includes(",")) variables[l.split(",")[1].trim()] = res;
                printLog(res); matched = true;
            }
            else if (l.startsWith("{{")) {
                let s = l.match(/\d+/)[0];
                await new Promise(r => setTimeout(r, s * 1000));
                matched = true;
            }
            else if (l.startsWith("{")) {
                let name = l.match(/\{([^,\]\}]+)/)[1];
                if (l.includes("[")) lists[name] = JSON.parse(l.match(/\[.*\]/)[0].replace(/'/g, '"'));
                else if (l.includes("push=")) lists[name].push(l.match(/"(.*)"/)[1]);
                else if (l.includes("De")) lists[name] = [];
                matched = true;
            }

            if (!matched && !skipMode) printLog(`エラー: 「${l}」は意味不明な言語です`, "error");
        }
    }
</script>
</body>
</html>
